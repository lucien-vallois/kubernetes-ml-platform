name: Test ML Platform

on:
  push:
    branches: [main, develop]
    paths:
      - 'terraform/**'
      - 'helm/**'
      - 'manifests/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'terraform/**'
      - 'helm/**'
      - 'manifests/**'

env:
  TF_VERSION: 1.0.0
  HELM_VERSION: v3.8.0

jobs:
  lint:
    name: 'Lint'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Setup Helm
      uses: azure/setup-helm@v3
      with:
        version: ${{ env.HELM_VERSION }}

    - name: Terraform Format Check
      run: |
        cd terraform
        terraform fmt -check -recursive

    - name: Helm Lint
      run: |
        helm lint helm/ml-service
        helm lint helm/monitoring

    - name: YAML Lint
      uses: ibiqlik/action-yamllint@v3
      with:
        file_or_dir: manifests/
        config_file: .yamllint.yml

  validate:
    name: 'Validate'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Validate
      run: |
        cd terraform
        terraform init -backend=false
        terraform validate

  security:
    name: 'Security Scan'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  test-manifests:
    name: 'Test Manifests'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: Validate Kubernetes manifests
      run: |
        # Validate YAML syntax
        find manifests/ -name "*.yaml" -exec kubectl --dry-run=client --validate=true apply -f {} \;

    - name: Test Helm templates
      run: |
        helm template test-ml-service helm/ml-service > /dev/null
        helm template test-monitoring helm/monitoring > /dev/null



